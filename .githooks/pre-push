#!/bin/bash
# Pre-push hook: Algorithm Portfolio Validation
#
# Validates that all algorithms in ALGORITHM_MANIFEST.json are present
# before allowing a push. This is a local safety net -- the CI/CD
# pipeline (GitHub Actions) is the enforcement layer.
#
# Install this hook:
#   git config core.hooksPath .githooks
#
# Or copy to .git/hooks/:
#   cp .githooks/pre-push .git/hooks/pre-push && chmod +x .git/hooks/pre-push
#
# Bypass (emergency only):
#   git push --no-verify

set -e

# Only validate when pushing to main
while read local_ref local_sha remote_ref remote_sha; do
    if echo "$remote_ref" | grep -q "refs/heads/main"; then
        echo ""
        echo "============================================"
        echo "  Pre-push: Algorithm Portfolio Validation"
        echo "============================================"
        echo ""
        echo "Validating algorithm portfolio before push to main..."
        echo ""

        # Find the project root (where this hook lives)
        HOOK_DIR="$(cd "$(dirname "$0")" && pwd)"
        # Handle both .githooks/ and .git/hooks/ locations
        if echo "$HOOK_DIR" | grep -q ".git/hooks"; then
            PROJECT_ROOT="$(cd "$HOOK_DIR/../.." && pwd)"
        else
            PROJECT_ROOT="$(cd "$HOOK_DIR/.." && pwd)"
        fi

        SCRIPT="$PROJECT_ROOT/scripts/validate_algorithms.py"

        if [ ! -f "$SCRIPT" ]; then
            echo "WARNING: validate_algorithms.py not found at $SCRIPT"
            echo "Skipping portfolio validation (script missing)."
            echo "This is a safety concern -- please restore the script."
            exit 0
        fi

        python3 "$SCRIPT"
        EXIT_CODE=$?

        if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "BLOCKED: Algorithm portfolio is incomplete."
            echo "Fix the issues above before pushing to main."
            echo ""
            echo "If this is intentional (e.g., removing an algorithm),"
            echo "update ALGORITHM_MANIFEST.json first."
            echo ""
            echo "Emergency bypass: git push --no-verify"
            echo ""
            exit 1
        fi

        echo "Portfolio validation passed. Proceeding with push."
        echo ""
    fi
done

exit 0
